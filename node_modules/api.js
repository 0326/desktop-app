var db = require('db');
var Common = require('common');
var User = require('user');
var Tags = db.tags;
var needle = require('needle');
var fs = require('fs');

function log(o) {
	console.log(o);
}

// 远程数据服务
var Api = {
	baseUrl: 'http://localhost:9000/api',
	getUrl: function(url, param) {
		var url = this.baseUrl + '/' + url;
		if(param) {
			var paramStr = '';
			for(var i in param) {
				paramStr += i + '=' + param[i] + '&';
			}
		}
		if(url.indexOf('?') >= 0) {
			return url + '&' + paramStr;
		}
		return url + '?' + paramStr;
	},
	isOk: function(ret) {
		// 数组
		if(length in ret) {
			return true;
		}
		if(ret == 'object') {
			if(!ret.Ok) { // 指明了Ok
				return false;
			}
			return true;
		}
		return false;
	},
	// 登录
	auth: function(email, pwd, callback) { 
		var me = this;
		log({emai: email, pwd: pwd});
		needle.get(this.getUrl('auth/login', {email: email, pwd: pwd}), function(error, response) {
		// needle.get('http://localhost/phpinfo.php?email=xx', {emai: email, pwd: pwd}, function(error, response) {
			var ret = response.body;
			// 登录成功, 保存token
			log(ret);
			if(me.isOk(ret)) {
				ret.Pwd = pwd;
				User.setCurUser(ret);
				callback && callback(ret);
			} else {
				log('log failed');
				callback && callback(false);
			}
		});
	},
	post: function() {
		var me = this;
		var options = {
			headers: { 'X-Custom-Header': 'Bumbaway atuna' }
		}
		// you can pass params as a string or as an object.
		needle.post(me.getUrl('auth/login'), 'foo=bar', options, function(err, resp) {
			var ret = resp.body;
			log(ret);
		});	
	},
	// get图片
	getImage: function(callback) {
		needle.get('http://localhost:9000/images/logo.png', function(err, resp) {
			// log(resp.body);
			/*
			{ 'accept-ranges': 'bytes',
			  'content-disposition': 'inline; filename="logo.png"',
			  'content-length': '8583',
			  'content-type': 'image/png',
			  date: 'Mon, 19 Jan 2015 15:01:47 GMT',
  			*/
			// log(resp.headers);
			fs.writeFile('/Users/life/Desktop/aa.png', resp.body);
		});
	},
	uploadImage: function() {
		var data = {
			foo: 'bar',
			image: { file: '/Users/life/Desktop/aa.png', content_type: 'image/png' }
		}
		needle.post('http://localhost/phpinfo.php', data, { multipart: true }, function(err, resp, body) {
			// needle will read the file and include it in the form-data as binary
		});
	},
	getSyncNotebooks: function(afterUsn, maxEntry, callback) {
		var me = this;
		needle.get(this.getUrl('notebook/getSyncNotebooks', {afterUsn: afterUsn, maxEntry: maxEntry}), function(error, response) {
			var ret = response.body;
			if(me.isOk(ret)) {
				callback && callback(ret);
			} else {
				callback && callback(false);
			}
		});	
	},
	getSyncNotes: function(afterUsn, maxEntry, callback) {
		var me = this;
		needle.get(this.getUrl('note/getSyncNotes', {afterUsn: afterUsn, maxEntry: maxEntry}), function(error, response) {
			var ret = response.body;
			if(me.isOk(ret)) {
				callback && callback(ret);
			} else {
				callback && callback(false);
			}
		});	
	}
};
module.exports = Api;